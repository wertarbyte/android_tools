#!/system/bin/sh
#
# Executes commands from a chroot environment

# location of (debian) chroot (without trailing /)
DEB=/system/sd/debian
SWAPFILE=/system/sd/swapfile

PATH="/usr/bin:/usr/sbin:/bin:/sbin:/system/sbin:/system/bin:/system/xbin:/system/xbin/bb:/data/local/bin"

mounted() {
  awk -vDIR=$1 '$2 == DIR { MOUNTED=1;} END {exit ! MOUNTED;}' /proc/mounts
}

swap_active() {
  awk -vSWAP=$1 'NR>1 && $1 == SWAP { ACTIVE=1;} END {exit ! ACTIVE;}' /proc/swaps
}

gen_pattern() {
  local i=$1
  while [ $i -gt 0 ]; do
    echo -n '?'
    i=$(($i-1))
  done
}

is_subdir() {
  local DIR="$1"
  local BASE="$2"
  [ "$DIR" = "$BASE" ] && return 0
  
  local OFFSET=$(( ${#DIR} - ${#BASE} - 1 ))
  local PARTDIR=${DIR%$(gen_pattern $OFFSET)}
  [ "$PARTDIR" = "${BASE}/" ] && return 0
  
  return 1;
}

no_apps_running() {
  for l in /proc/*/root; do
    local ROOT=$(readlink "$l")
    # is the program / part of the chroot?
    is_subdir "$ROOT" "$DEB" && return 1
  done
  return 0
}

mounted $DEB/proc    || mount proc -t proc $DEB/proc
mounted $DEB/sys     || mount sysfs -t sysfs $DEB/sys
mounted $DEB/dev     || mount --rbind /dev $DEB/dev
mounted $DEB/dev/pts || mount devpts -t devpts $DEB/dev/pts

# activate swap if specified
[ -e "$SWAPFILE" ] && \
  ! swap_active "$SWAPFILE" && \
  swapon "$SWAPFILE"

SHELL=/bin/bash
HOME=/root
export SHELL
export HOME

chroot $DEB ${*:-$SHELL -l}

# deactivate swap if no apps left
swap_active "$SWAPFILE" && \
  no_apps_running && \
  swapoff "$SWAPFILE"
