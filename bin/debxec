#!/system/bin/sh
#
# Executes commands from a chroot environment

# location of (debian) chroot (without trailing /)
DEB=/system/sd/debian
SWAPFILE=/system/sd/swapfile
# configuration file with directories to bind-mount into the chroot
BINDTAB=/system/sd/bindtab

PATH="/usr/bin:/usr/sbin:/bin:/sbin:/system/sbin:/system/bin:/system/xbin:/system/xbin/bb:/data/local/bin"

mounted() {
  awk -vDIR=$1 '$2 == DIR { MOUNTED=1;} END {exit ! MOUNTED;}' /proc/mounts
}

swap_active() {
  awk -vSWAP=$1 'NR>1 && $1 == SWAP { ACTIVE=1;} END {exit ! ACTIVE;}' /proc/swaps
}

gen_pattern() {
  local i=$1
  while [ $i -gt 0 ]; do
    echo -n '?'
    i=$(($i-1))
  done
}

is_subdir() {
  local DIR="$1"
  local BASE="$2"
  [ "$DIR" = "$BASE" ] && return 0
  
  local OFFSET=$(( ${#DIR} - ${#BASE} - 1 ))
  local PARTDIR=${DIR%$(gen_pattern $OFFSET)}
  [ "$PARTDIR" = "${BASE}/" ] && return 0
  
  return 1;
}

no_apps_running() {
  for l in /proc/*/root; do
    local ROOT=$(readlink "$l")
    # is the program / part of the chroot?
    is_subdir "$ROOT" "$DEB" && return 1
  done
  return 0
}

build_chroot() {
    # mount essential file systems into the chroot
    mounted $DEB/proc    || mount proc -t proc $DEB/proc
    mounted $DEB/sys     || mount sysfs -t sysfs $DEB/sys
    mounted $DEB/dev     || mount --rbind /dev $DEB/dev
    mounted $DEB/dev/pts || mount devpts -t devpts $DEB/dev/pts
    # bind mount custom directories
    if [ -e "$BINDTAB" ]; then
      # remove comments
      sed 's!#.*$!!;/^[[:space:]]*$/d;' "$BINDTAB" | \
      while read SRC DST; do
        mounted ${DEV}${DST} || mount --rbind "$SRC" "${DEB}${DST}"
      done
    fi
}

teardown_chroot() {
    # unmount all file systems beneath the chroot
    tac /proc/mounts | while read DEV DIR FS OPTS X Y; do
        if is_subdir "$DIR" "$DEB"; then
            umount "$DIR"
        fi
    done
}

build_chroot

# activate swap if specified
[ -e "$SWAPFILE" ] && \
  ! swap_active "$SWAPFILE" && \
  swapon "$SWAPFILE"

SHELL=/bin/bash
HOME=/root
export SHELL
export HOME

chroot $DEB ${*:-$SHELL -l}

# deactivate swap and unmount if no apps left
if no_apps_running; then
    swap_active "$SWAPFILE" && \
        swapoff "$SWAPFILE"
    teardown_chroot
fi
